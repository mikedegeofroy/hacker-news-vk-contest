{"version":3,"file":"DefaultRouteNavigator.js","sourceRoot":"","sources":["../../src/services/DefaultRouteNavigator.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockerFunction, Params, Router, RouterNavigateOptions } from '@remix-run/router';\nimport { createKey, fillParamsIntoPath, isModalShown, isPopoutShown } from '../utils/utils';\nimport {\n  NAVIGATION_BLOCKER_KEY,\n  STATE_KEY_BLOCK_FORWARD_NAVIGATION,\n  STATE_KEY_SHOW_MODAL,\n  STATE_KEY_SHOW_POPOUT,\n} from '../const';\nimport { hasNavigationOptionsKeys, NavigationOptions, RouteNavigator } from './RouteNavigator.type';\nimport { buildPanelPathFromModalMatch } from '../utils/buildPanelPathFromModalMatch';\nimport { InternalRouteConfig, ModalWithRoot } from '../type';\nimport { Page, PageWithParams } from '../page-types/common';\nimport { ViewHistory } from './ViewHistory';\nimport { TransactionExecutor } from './TransactionExecutor';\nimport { NavigationTransaction } from '../entities/NavigationTransaction';\n\nexport class DefaultRouteNavigator implements RouteNavigator {\n  private readonly router: Router;\n  private readonly setPopout: (popout: JSX.Element | null) => void;\n  private blockers: Map<string, BlockerFunction> = new Map();\n  private blockerId = 0;\n\n  constructor(\n    router: Router,\n    private viewHistory: ViewHistory,\n    private transactionExecutor: TransactionExecutor,\n    setPopout: (popout: JSX.Element | null) => void,\n  ) {\n    this.router = router;\n    this.setPopout = setPopout;\n  }\n\n  public async push(\n    to: string | Page | PageWithParams<string>,\n    paramsOrOptions: Params | NavigationOptions = {},\n    options: NavigationOptions = {},\n  ): Promise<void> {\n    const paramsAreOptions = hasNavigationOptionsKeys(paramsOrOptions);\n    const preparedOptions: NavigationOptions = paramsAreOptions ? paramsOrOptions : options;\n    const fullOptions = {\n      ...preparedOptions,\n      replace: Boolean(this.router.state.location.state?.[STATE_KEY_BLOCK_FORWARD_NAVIGATION]),\n    };\n    const preparedParams: Params = paramsAreOptions ? {} : (paramsOrOptions as Params);\n    await this.navigate(to, fullOptions, preparedParams);\n  }\n\n  public async replace(\n    to: string | Page | PageWithParams<string>,\n    paramsOrOptions: Params | NavigationOptions = {},\n    options: NavigationOptions = {},\n  ): Promise<void> {\n    const paramsAreOptions = hasNavigationOptionsKeys(paramsOrOptions);\n    const preparedOptions: NavigationOptions = paramsAreOptions ? paramsOrOptions : options;\n    const preparedParams: Params = paramsAreOptions ? {} : (paramsOrOptions as Params);\n    await this.navigate(to, { ...preparedOptions, replace: true }, preparedParams);\n  }\n\n  public async back(to = 1): Promise<void> {\n    if (to === 0) {\n      return;\n    }\n    await this.go(-Math.abs(to));\n  }\n\n  public async backToFirst(): Promise<void> {\n    if (this.viewHistory.position > 0) {\n      await this.go(-this.viewHistory.position);\n    } else {\n      await this.transactionExecutor.doNext();\n    }\n  }\n\n  public async go(to: number): Promise<void> {\n    if (to === 0) {\n      await this.transactionExecutor.doNext();\n    } else {\n      await this.router.navigate(to);\n    }\n  }\n\n  public runSync(actions: VoidFunction[]): Promise<void> {\n    const transaction = new NavigationTransaction(actions);\n    this.transactionExecutor.add(transaction);\n    this.transactionExecutor.doNext();\n    return transaction.donePromise;\n  }\n\n  public async showModal(id: string): Promise<void> {\n    await this.router.navigate(this.router.state.location, {\n      state: { [STATE_KEY_SHOW_MODAL]: id, [STATE_KEY_BLOCK_FORWARD_NAVIGATION]: true },\n      replace: isModalShown(this.router.state.location),\n    });\n  }\n\n  public async hideModal(pushPanel = false): Promise<void> {\n    if ((!pushPanel && !this.viewHistory.isFirstPage) || isModalShown(this.router.state.location)) {\n      await this.router.navigate(-1);\n    } else {\n      const modalMatch = this.router.state.matches.find((match) => 'modal' in match.route);\n      if (modalMatch) {\n        const route = modalMatch.route as ModalWithRoot & InternalRouteConfig;\n        const path = buildPanelPathFromModalMatch(modalMatch, this.router);\n        if (!path) {\n          const rootMessage = route.root ? `root: ${route.root} ` : '';\n          throw new Error(`There is no route registered for panel with ${rootMessage}, view: ${route.view}, panel: ${route.panel}.\nMake sure this route exists or use hideModal with pushPanel set to false.`);\n        }\n        await this.navigate(path, { keepSearchParams: true });\n      } else {\n        await this.transactionExecutor.doNext();\n      }\n    }\n  }\n\n  public async showPopout(popout: JSX.Element): Promise<void> {\n    this.setPopout(popout);\n    const state: any = {\n      [STATE_KEY_SHOW_POPOUT]: createKey(),\n      [STATE_KEY_BLOCK_FORWARD_NAVIGATION]: true,\n    };\n    if (isModalShown(this.router.state.location)) {\n      state[STATE_KEY_SHOW_MODAL] = this.router.state.location.state[STATE_KEY_SHOW_MODAL];\n    }\n    const replace =\n      isModalShown(this.router.state.location) || isPopoutShown(this.router.state.location);\n    await this.router.navigate(this.router.state.location, { state, replace });\n  }\n\n  public async hidePopout(): Promise<void> {\n    if (isPopoutShown(this.router.state.location)) {\n      this.setPopout(null);\n      if (isModalShown(this.router.state.location)) {\n        await this.router.navigate(this.router.state.location, {\n          state: {\n            [STATE_KEY_BLOCK_FORWARD_NAVIGATION]: true,\n            [STATE_KEY_SHOW_MODAL]: this.router.state.location.state[STATE_KEY_SHOW_MODAL],\n          },\n          replace: true,\n        });\n      } else {\n        await this.router.navigate(-1);\n      }\n    } else {\n      await this.transactionExecutor.doNext();\n    }\n  }\n\n  public block(blocker: BlockerFunction) {\n    const key = (++this.blockerId).toString();\n    this.blockers.set(key, blocker);\n    const onLeave: BlockerFunction = (data) => {\n      return Array.from(this.blockers.values()).some((fn) => fn(data));\n    };\n    this.router.getBlocker(NAVIGATION_BLOCKER_KEY, onLeave);\n\n    return () => {\n      this.blockers.delete(key);\n    };\n  }\n\n  private async navigate(\n    to: string | Page | PageWithParams<string>,\n    opts?: RouterNavigateOptions & NavigationOptions,\n    params: Params = {},\n  ): Promise<void> {\n    // prettier-ignore\n    let path = typeof to === 'string'\n      ? to\n      : to.hasParams\n        ? fillParamsIntoPath(to.path, params)\n        : to.path;\n\n    if (opts?.keepSearchParams) {\n      path += this.router.state.location.search;\n    }\n\n    await this.router.navigate(path, opts);\n  }\n}\n"]}