{"version":3,"sources":["../../../../src/components/Tappable/Ripple.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames, hasMouse as hasPointerLib, noop } from '@vkontakte/vkjs';\nimport { usePlatform } from '../../hooks/usePlatform';\nimport { useTimeout } from '../../hooks/useTimeout';\nimport { getOffsetRect } from '../../lib/offset';\nimport styles from './Tappable.module.css';\n\n/**\n * Возможно нужен Ripple эффект. Данный хук нужен для отказа\n * от двойного ререндера.\n */\nexport const useMaybeNeedRipple = (activeMode: string, hasPointer: boolean | undefined) => {\n  const platform = usePlatform();\n\n  return platform === 'android' && !hasPointer && activeMode === 'background';\n};\n\ninterface Wave {\n  x: number;\n  y: number;\n  id: number;\n  pointerId: number;\n}\n\nconst DELAY = 70;\nconst WAVE_LIVE = 225;\n\n/**\n * Хук для создания Ripple эффектов\n */\nexport const useRipple = (needRipple: boolean, hasPointerContext: boolean | undefined) => {\n  const [clicks, setClicks] = React.useState<Wave[]>([]);\n\n  /**\n   * Коллекция нажатий и таймеров задержки появления волны\n   */\n  const pointerDelayTimers = React.useMemo(\n    () => new Map<number, ReturnType<typeof setTimeout>>(),\n    [],\n  );\n\n  const clearClicks = useTimeout(() => setClicks([]), WAVE_LIVE);\n\n  function addClick(x: number, y: number, pointerId: number) {\n    const dateNow = Date.now();\n    const filteredClicks = clicks.filter((click) => click.id + WAVE_LIVE > dateNow);\n\n    setClicks([...filteredClicks, { x, y, id: dateNow, pointerId }]);\n    clearClicks.set();\n    pointerDelayTimers.delete(pointerId);\n  }\n\n  /**\n   * Добавляем волну с задержкой. Задержка необходима при отмене волны.\n   */\n  const onPointerDown: React.PointerEventHandler<HTMLSpanElement> = (e) => {\n    const { top, left } = getOffsetRect(e.currentTarget);\n    const x = e.clientX - (left ?? 0);\n    const y = e.clientY - (top ?? 0);\n\n    pointerDelayTimers.set(\n      e.pointerId,\n      setTimeout(() => addClick(x, y, e.pointerId), DELAY),\n    );\n  };\n\n  const onPointerCancel: React.PointerEventHandler<HTMLSpanElement> = (e) => {\n    const timer = pointerDelayTimers.get(e.pointerId);\n    clearTimeout(timer);\n    pointerDelayTimers.delete(e.pointerId);\n  };\n\n  // WARNING: не использовать для рендеринга\n  const reallyNeedRipple = (!hasPointerLib || hasPointerContext === false) && needRipple;\n\n  return {\n    clicks,\n    onPointerDown: reallyNeedRipple ? onPointerDown : noop,\n    onPointerCancel: reallyNeedRipple ? onPointerCancel : noop,\n  };\n};\n\nexport interface RippleProps {\n  needRipple: boolean;\n  clicks: Wave[];\n}\n\nexport const Ripple = ({ needRipple = true, clicks }: RippleProps) => {\n  return (\n    <span\n      aria-hidden\n      className={classNames(\n        styles['Tappable__stateLayer'],\n        needRipple && styles['Tappable__ripple'],\n      )}\n    >\n      {clicks.map((wave) => (\n        <span\n          key={wave.id}\n          className={styles['Tappable__wave']}\n          style={{ top: wave.y, left: wave.x }}\n        />\n      ))}\n    </span>\n  );\n};\n"],"names":["Ripple","useMaybeNeedRipple","useRipple","activeMode","hasPointer","platform","usePlatform","DELAY","WAVE_LIVE","needRipple","hasPointerContext","clicks","setClicks","React","useState","pointerDelayTimers","useMemo","Map","clearClicks","useTimeout","addClick","x","y","pointerId","dateNow","Date","now","filteredClicks","filter","click","id","set","delete","onPointerDown","e","top","left","getOffsetRect","currentTarget","clientX","clientY","setTimeout","onPointerCancel","timer","get","clearTimeout","reallyNeedRipple","hasPointerLib","noop","span","aria-hidden","className","classNames","map","wave","key","style"],"mappings":";;;;;;;;;;;IAuFaA,MAAM;eAANA;;IA5EAC,kBAAkB;eAAlBA;;IAmBAC,SAAS;eAATA;;;;iEA9BU;sBACqC;6BAChC;4BACD;wBACG;AAOvB,MAAMD,qBAAqB,CAACE,YAAoBC;IACrD,MAAMC,WAAWC,IAAAA,wBAAW;IAE5B,OAAOD,aAAa,aAAa,CAACD,cAAcD,eAAe;AACjE;AASA,MAAMI,QAAQ;AACd,MAAMC,YAAY;AAKX,MAAMN,YAAY,CAACO,YAAqBC;IAC7C,MAAM,CAACC,QAAQC,UAAU,GAAGC,OAAMC,QAAQ,CAAS,EAAE;IAErD;;GAEC,GACD,MAAMC,qBAAqBF,OAAMG,OAAO,CACtC,IAAM,IAAIC,OACV,EAAE;IAGJ,MAAMC,cAAcC,IAAAA,sBAAU,EAAC,IAAMP,UAAU,EAAE,GAAGJ;IAEpD,SAASY,SAASC,CAAS,EAAEC,CAAS,EAAEC,SAAiB;QACvD,MAAMC,UAAUC,KAAKC,GAAG;QACxB,MAAMC,iBAAiBhB,OAAOiB,MAAM,CAAC,CAACC,QAAUA,MAAMC,EAAE,GAAGtB,YAAYgB;QAEvEZ,UAAU;eAAIe;YAAgB;gBAAEN;gBAAGC;gBAAGQ,IAAIN;gBAASD;YAAU;SAAE;QAC/DL,YAAYa,GAAG;QACfhB,mBAAmBiB,MAAM,CAACT;IAC5B;IAEA;;GAEC,GACD,MAAMU,gBAA4D,CAACC;QACjE,MAAM,EAAEC,GAAG,EAAEC,IAAI,EAAE,GAAGC,IAAAA,qBAAa,EAACH,EAAEI,aAAa;QACnD,MAAMjB,IAAIa,EAAEK,OAAO,GAAIH,CAAAA,iBAAAA,kBAAAA,OAAQ,CAAA;QAC/B,MAAMd,IAAIY,EAAEM,OAAO,GAAIL,CAAAA,gBAAAA,iBAAAA,MAAO,CAAA;QAE9BpB,mBAAmBgB,GAAG,CACpBG,EAAEX,SAAS,EACXkB,WAAW,IAAMrB,SAASC,GAAGC,GAAGY,EAAEX,SAAS,GAAGhB;IAElD;IAEA,MAAMmC,kBAA8D,CAACR;QACnE,MAAMS,QAAQ5B,mBAAmB6B,GAAG,CAACV,EAAEX,SAAS;QAChDsB,aAAaF;QACb5B,mBAAmBiB,MAAM,CAACE,EAAEX,SAAS;IACvC;IAEA,0CAA0C;IAC1C,MAAMuB,mBAAmB,AAAC,CAAA,CAACC,cAAa,IAAIrC,sBAAsB,KAAI,KAAMD;IAE5E,OAAO;QACLE;QACAsB,eAAea,mBAAmBb,gBAAgBe,UAAI;QACtDN,iBAAiBI,mBAAmBJ,kBAAkBM,UAAI;IAC5D;AACF;AAOO,MAAMhD,SAAS,CAAC,EAAES,aAAa,IAAI,EAAEE,MAAM,EAAe;IAC/D,qBACE,qBAACsC;QACCC,eAAAA;QACAC,WAAWC,IAAAA,gBAAU,8BAEnB3C;OAGDE,OAAO0C,GAAG,CAAC,CAACC,qBACX,qBAACL;YACCM,KAAKD,KAAKxB,EAAE;YACZqB,SAAS;YACTK,OAAO;gBAAErB,KAAKmB,KAAKhC,CAAC;gBAAEc,MAAMkB,KAAKjC,CAAC;YAAC;;AAK7C"}