{"version":3,"sources":["../../../../src/components/ModalRoot/ModalRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames } from '@vkontakte/vkjs';\nimport { clamp } from '../../helpers/math';\nimport { withContext } from '../../hoc/withContext';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { setTransformStyle } from '../../lib/styles';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { rubber } from '../../lib/touch';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { ConfigProviderContext } from '../ConfigProvider/ConfigProviderContext';\nimport { FocusTrap } from '../FocusTrap/FocusTrap';\nimport { Touch, TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { ModalRootContext, ModalRootContextInterface } from './ModalRootContext';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { ModalRootWithDOMProps, ModalsStateEntry, TranslateRange } from './types';\nimport { ModalTransitionProps, withModalManager } from './useModalManager';\nimport styles from './ModalRoot.module.css';\n\nconst warn = warnOnce('ModalRoot');\n\nfunction numberInRange(number: number, range: TranslateRange | undefined) {\n  if (!range) {\n    return false;\n  }\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return clamp(number, 0, 98);\n}\n\ninterface ModalRootState {\n  touchDown?: boolean;\n  dragging?: boolean;\n  modalOpenedLog: string[];\n}\n\nclass ModalRootTouchComponent extends React.Component<\n  ModalRootWithDOMProps & DOMProps & ModalTransitionProps,\n  ModalRootState\n> {\n  constructor(props: ModalRootWithDOMProps & ModalTransitionProps) {\n    super(props);\n    this.state = {\n      touchDown: false,\n      dragging: false,\n      modalOpenedLog: [],\n    };\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n      registerModal: ({ id, ...data }) => Object.assign(this.props.getModalState(id) ?? {}, data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n\n    this.frameIds = {};\n  }\n\n  private documentScrolling = false;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private readonly viewportRef = React.createRef<HTMLDivElement>();\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n  private restoreFocusTo: HTMLElement | undefined | null = undefined;\n\n  get timeout(): number {\n    return this.props.platform === 'ios' ? 400 : 320;\n  }\n\n  get document(): Document {\n    return this.props.document as Document;\n  }\n\n  get window(): Window {\n    return this.props.window as Window;\n  }\n\n  getModals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  componentDidMount() {\n    // Отслеживаем изменение размеров viewport\n    this.window?.addEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n    this.window.removeEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentDidUpdate(prevProps: ModalRootWithDOMProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n      const enteringState = this.props.getModalState(this.props.enteringModal);\n      this.props.onEnter();\n      this.waitTransitionFinish(enteringState, () => {\n        if (enteringState) {\n          if (enteringState.innerElement) {\n            enteringState.innerElement.style.transitionDelay = '';\n          }\n          this.onEntered(enteringState);\n        }\n      });\n\n      if (enteringState?.innerElement) {\n        enteringState.innerElement.style.transitionDelay = this.props.delayEnter\n          ? `${this.timeout}ms`\n          : '';\n        this.animateTranslate(enteringState, enteringState.translateY);\n        this.setMaskOpacity(enteringState, 1);\n      }\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = this.document.activeElement as HTMLElement;\n    }\n    if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = null;\n    }\n\n    this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // восстанавливаем значение overscroll behavior\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.remove('vkui--disable-overscroll-behavior');\n\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      this.window.removeEventListener('touchmove', this.preventTouch, {\n        // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n        passive: false,\n      });\n    } else {\n      // отключаем нативный pull-to-refresh при открытом модальном окне\n      // чтобы он не срабатывал при закрытии модалки смахиванием вниз\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.add('vkui--disable-overscroll-behavior');\n\n      this.window.addEventListener('touchmove', this.preventTouch, {\n        passive: false,\n      });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  checkPageContentHeight() {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === 'page' && modalState?.modalElement) {\n      const prevModalState = { ...modalState };\n      initPageModal(modalState);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState, modalState.translateY);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState && modalState.type === 'page') {\n      if (this.props.enteringModal) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  onEntered({ id, modalElement }: ModalsStateEntry) {\n    if (\n      !this.props.noFocusToDialog &&\n      modalElement &&\n      !modalElement.contains(this.document.activeElement)\n    ) {\n      modalElement.focus();\n    }\n\n    this.props.onEntered(id);\n  }\n\n  closeModal(id: string) {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false });\n\n    const prevModalState = this.props.getModalState(id);\n\n    if (!prevModalState) {\n      id && warn(`closeActiveModal: модальное окно (страница) ${id} не существует`, 'error');\n      return;\n    }\n    if (!this.state.modalOpenedLog.length) {\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, id],\n      }));\n    }\n    const nextModalState = this.props.getModalState(this.props.activeModal);\n    const nextIsPage = !!nextModalState && nextModalState.type === 'page';\n\n    const prevIsPage = !!prevModalState && prevModalState.type === 'page';\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    const exitTranslate =\n      prevIsPage &&\n      nextIsPage &&\n      (prevModalState.translateY ?? 0) <= (nextModalState?.translateYFrom ?? 0) &&\n      !this.props.isBack\n        ? (nextModalState?.translateYFrom ?? 0) + 10\n        : 100;\n    this.animateTranslate(prevModalState, exitTranslate);\n\n    if (!nextModalState) {\n      // NOTE: was only for clean exit\n      this.setMaskOpacity(prevModalState, 0);\n      this.setState({ modalOpenedLog: [] });\n      prevModalState.translateY = undefined;\n      prevModalState.expandable = undefined;\n    } else if (nextModalState.id && !this.state.modalOpenedLog.includes(nextModalState.id)) {\n      nextModalState.translateY = undefined;\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, nextModalState.id!],\n      }));\n    }\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.props.exitingModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(this.props.activeModal);\n    if (!modalState) {\n      return;\n    }\n\n    if (modalState.type === 'page') {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === 'card') {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, originalEvent } = event;\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (this.viewportRef.current?.contains(target)) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!modalState.innerElement?.contains(target)) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartContentScrollTop = modalState.contentElement?.scrollTop ?? 0;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      (expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0) ||\n      modalState.headerElement?.contains(target)\n    ) {\n      originalEvent.preventDefault();\n\n      if ((!expandable && shiftY < 0) || !this.window) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = (shiftY / this.window.innerHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== 'ios');\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate((modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (modalState.innerElement?.contains(target)) {\n      if (!this.state.touchDown) {\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = (shiftY / modalState.innerElement.offsetHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== 'ios');\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, (modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === 'page') {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState?.type === 'card') {\n      return this.onCardTouchEnd(e, modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let setStateCallback;\n\n    if (this.state.dragging && this.window) {\n      const shiftYEndPercent = ((startY + shiftY) / this.window.innerHeight) * 100;\n\n      let translateY = modalState.translateYCurrent ?? 0;\n      const expectTranslateY =\n        (translateY / event.duration) *\n        240 *\n        0.6 *\n        ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (modalState.settlingHeight !== 100) {\n        if (numberInRange(translateY, modalState.expandedRange)) {\n          translateY = modalState.expandedRange?.[0] ?? 0;\n        } else if (numberInRange(translateY, modalState.collapsedRange)) {\n          translateY = modalState.translateYFrom ?? 0;\n        } else if (numberInRange(translateY, modalState.hiddenRange)) {\n          translateY = 100;\n        } else {\n          translateY = modalState.translateYFrom ?? 0;\n        }\n      } else {\n        if (numberInRange(translateY, [0, 25])) {\n          translateY = 0;\n        } else {\n          translateY = 100;\n        }\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = numberInRange(translateY, modalState.collapsedRange);\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onCardTouchEnd({ duration }: TouchEvent, modalState: ModalsStateEntry) {\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent ?? 0;\n\n      const expectTranslateY =\n        (translateY / duration) * 240 * 0.6 * ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onScroll = (e: React.SyntheticEvent) => {\n    const activeModal = this.props.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(activeModal);\n    if (modalState?.type === 'page' && modalState?.contentElement?.contains(target)) {\n      modalState.contentScrolled = true;\n\n      if (modalState.contentScrollStopTimeout) {\n        clearTimeout(modalState.contentScrollStopTimeout);\n      }\n\n      modalState.contentScrollStopTimeout = setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry | undefined, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(transitionEvent.name as string, onceHandler);\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(transitionEvent.name as string, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /**\n   * Анимирует сдвиг модалки\n   *\n   * @param {ModalsStateEntry} modalState\n   * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n   */\n  animateTranslate(modalState: ModalsStateEntry, percent: number | undefined) {\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translate3d(0, ${percent}%, 0)`);\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number | null = null) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n        this.maskElementRef.current.style.transitionDelay =\n          opacity && this.props.delayEnter ? `${this.timeout}ms` : '';\n      }\n    });\n  }\n\n  render() {\n    const { activeModal, exitingModal, enteringModal, modalOverlayTestId } = this.props;\n    const { touchDown, dragging } = this.state;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            className={classNames(\n              styles['ModalRoot'],\n              this.props.configProvider?.hasCustomPanelHeaderAfter &&\n                styles['ModalRoot--hasCustomPanelHeaderAfterSlot'],\n              touchDown &&\n                classNames(styles['ModalRoot--touched'], 'vkuiInternalModalRoot--touched'),\n              !!(enteringModal || exitingModal) &&\n                classNames(styles['ModalRoot--switching'], 'vkuiInternalModalRoot--switching'),\n            )}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              data-testid={modalOverlayTestId}\n              className={styles['ModalRoot__mask']}\n              onClick={this.props.onExit}\n              ref={this.maskElementRef}\n            />\n            <div className={styles['ModalRoot__viewport']} ref={this.viewportRef}>\n              {this.getModals().map((Modal) => {\n                const modalId = getNavId(Modal.props, warn);\n                const _modalState = this.props.getModalState(modalId);\n                if ((modalId !== activeModal && modalId !== exitingModal) || !_modalState) {\n                  return null;\n                }\n                const modalState = { ..._modalState };\n\n                const isPage = modalState.type === 'page';\n                const key = `modal-${modalId}`;\n\n                return (\n                  <FocusTrap\n                    key={key}\n                    onClose={this.props.onExit}\n                    timeout={this.timeout}\n                    className={classNames(\n                      styles['ModalRoot__modal'],\n\n                      dragging && 'vkuiInternalModalRoot__modal--dragging',\n\n                      isPage && modalState.expandable && 'vkuiInternalModalRoot__modal--expandable',\n                      isPage && modalState.collapsed && 'vkuiInternalModalRoot__modal--collapsed',\n                    )}\n                    restoreFocus={false}\n                  >\n                    {Modal}\n                  </FocusTrap>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootTouch = withContext(\n  withPlatform(\n    withDOM<ModalRootWithDOMProps>(withModalManager(initModal)(ModalRootTouchComponent)),\n  ),\n  ConfigProviderContext,\n  'configProvider',\n);\n\n/**\n * Инициализирует модалку перед анимацией открытия\n */\nfunction initModal(modalState: ModalsStateEntry) {\n  switch (modalState.type) {\n    case 'page':\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n    case 'card':\n      return initCardModal(modalState);\n    default:\n      process.env.NODE_ENV === 'development' &&\n        warn(`initActiveModal: modalState.type=\"${modalState.type}\" не поддерживается`, 'error');\n  }\n}\n\nfunction initPageModal(modalState: ModalsStateEntry) {\n  const { contentElement, bottomInset } = modalState;\n  const contentElementHeight = calculateModalContentHeight(\n    contentElement?.firstElementChild as HTMLElement,\n    modalState.expandable,\n  );\n  const bottomInsetHeight = bottomInset?.offsetHeight || 0;\n  const contentHeight = contentElementHeight + bottomInsetHeight;\n  let prevTranslateY = modalState.translateY;\n  let prevExpandable = modalState.expandable;\n\n  modalState.expandable =\n    contentHeight > (contentElement?.clientHeight ?? 0) || modalState.settlingHeight === 100;\n\n  let collapsed = false;\n  let expanded = false;\n  let translateYFrom;\n  let translateY;\n  let expandedRange: TranslateRange;\n  let collapsedRange: TranslateRange | undefined;\n  let hiddenRange: TranslateRange;\n\n  const hasCollapsedState = Boolean(modalState.expandable && modalState.settlingHeight !== 100);\n  if (modalState.expandable) {\n    translateYFrom = 100 - (modalState.settlingHeight ?? 0);\n\n    const shiftHalf = translateYFrom / 2;\n    const visiblePart = 100 - translateYFrom;\n\n    expandedRange = [0, shiftHalf];\n    collapsedRange = hasCollapsedState ? [shiftHalf, translateYFrom + visiblePart / 4] : undefined;\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n    collapsed = hasCollapsedState && translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    const headerHeight = modalState.headerElement?.offsetHeight ?? 0;\n    const height = contentHeight + headerHeight;\n\n    translateYFrom =\n      100 - (height / (modalState.innerElement?.parentElement?.offsetHeight ?? 0)) * 100;\n    translateY = translateYFrom;\n\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = undefined;\n    hiddenRange = [translateY + 25, translateY + 100];\n  }\n\n  // Свойство expandable может измениться из-за высоты контента, в таком случае на всю высоту не разворачиваем\n  const shouldExpand = prevExpandable && modalState.expandable;\n  // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n  if ((shouldExpand && translateY > (prevTranslateY ?? 100)) || modalState.settlingHeight === 100) {\n    translateY = 0;\n  }\n\n  // Если модалка уже раскрыта обновляем состояния\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState: ModalsStateEntry) {\n  modalState.translateY = 0;\n}\n\nfunction calculateModalContentHeight(\n  element: HTMLElement,\n  isExpandable: ModalsStateEntry['expandable'],\n) {\n  if (!isExpandable) {\n    return element.scrollHeight;\n  }\n\n  /*\n   * В режиме expandable мы назначаем контейнеру контента высоту 100%, что не даёт\n   * получить реальную высоту контента.\n   * Поэтому мы пересчитываем высоту, временно устанавливая height: auto;\n   * */\n  const currentHeightStyle = element.style.height;\n  element.style.height = 'auto';\n\n  const elementHeight = element.scrollHeight;\n  element.style.height = currentHeightStyle;\n\n  return elementHeight;\n}\n"],"names":["ModalRootTouch","warn","warnOnce","numberInRange","number","range","rangeTranslate","clamp","ModalRootTouchComponent","React","Component","timeout","props","platform","document","window","getModals","Children","toArray","children","componentDidMount","addEventListener","updateModalHeight","componentWillUnmount","toggleDocumentScrolling","removeEventListener","componentDidUpdate","prevProps","exitingModal","closeModal","enteringModal","enteringState","getModalState","onEnter","waitTransitionFinish","innerElement","style","transitionDelay","onEntered","delayEnter","animateTranslate","translateY","setMaskOpacity","activeModal","restoreFocusTo","activeElement","focus","enabled","documentScrolling","documentElement","classList","remove","preventTouch","passive","add","checkPageContentHeight","modalState","type","modalElement","prevModalState","initPageModal","currentModalState","needAnimate","expandable","translateYFrom","id","noFocusToDialog","contains","setState","touchDown","state","modalOpenedLog","length","prevState","nextModalState","nextIsPage","prevIsPage","onExited","exitTranslate","isBack","undefined","includes","onPageTouchMove","event","shiftY","originalEvent","target","isY","viewportRef","current","preventDefault","stopPropagation","contentScrolled","collapsed","expanded","touchStartContentScrollTop","contentElement","scrollTop","touchMovePositive","headerElement","dragging","shiftYPercent","innerHeight","shiftYCurrent","rubber","touchShiftYPercent","translateYCurrent","onCardTouchMove","offsetHeight","Math","max","onPageTouchEnd","startY","setStateCallback","shiftYEndPercent","expectTranslateY","duration","settlingHeight","expandedRange","collapsedRange","hiddenRange","hidden","onExit","onCardTouchEnd","eventHandler","transitionEvent","supported","onceHandler","name","setTimeout","percent","frameId","cancelAnimationFrame","frameIds","requestAnimationFrame","setTransformStyle","forceOpacity","history","maskAnimationFrame","maskElementRef","opacity","toString","render","modalOverlayTestId","TouchRootContext","Provider","value","ModalRootContext","modalRootContext","Touch","className","classNames","configProvider","hasCustomPanelHeaderAfter","onMove","onTouchMove","onEnd","onTouchEnd","onScroll","div","data-testid","onClick","ref","map","Modal","modalId","getNavId","_modalState","isPage","key","FocusTrap","onClose","restoreFocus","constructor","createRef","e","contentScrollStopTimeout","clearTimeout","registerModal","data","Object","assign","isInsideModal","withContext","withPlatform","withDOM","withModalManager","initModal","ConfigProviderContext","MODAL_PAGE_DEFAULT_PERCENT_HEIGHT","initCardModal","process","env","NODE_ENV","bottomInset","contentElementHeight","calculateModalContentHeight","firstElementChild","bottomInsetHeight","contentHeight","prevTranslateY","prevExpandable","clientHeight","hasCollapsedState","Boolean","shiftHalf","visiblePart","headerHeight","height","parentElement","shouldExpand","element","isExpandable","scrollHeight","currentHeightStyle","elementHeight"],"mappings":"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"}