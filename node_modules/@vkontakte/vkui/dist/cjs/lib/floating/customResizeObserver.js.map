{"version":3,"sources":["../../../../src/lib/floating/customResizeObserver.ts"],"sourcesContent":["const defaultIframeStyles: Pick<\n  CSSStyleDeclaration,\n  'position' | 'left' | 'top' | 'zIndex' | 'width' | 'height' | 'pointerEvents' | 'opacity'\n> = {\n  position: 'absolute',\n  left: '0',\n  top: '0',\n  zIndex: '-1',\n  width: '100%',\n  height: '100%',\n  pointerEvents: 'none',\n  opacity: '0',\n};\n\n/*\n * Специальный CustomResizeObserver как fallback для ResizeObserver\n * Используется для вызова update() функции (перерисовка плавающего окна) floating-ui\n * при изменении размера reference или floating элементов.\n *\n * По умолчанию пытаемся нарисовать скрытый, абсолютно позиционированный относительно\n * наблюдаемого элемента iframe.\n * В случае же, если наблюдаемый элемент имеет position: static, то правильно спозиционировать\n * iframe у нас не получится, поэтому в такой ситуации мы используем MutationObserver.\n *\n * Использовать только MutationObserver мы не можем, потому что с помощью него нельзя отследить\n * изменение размера вызванное переполнением текста.\n *\n * Применяется только если нету поддержики или полифила ResizeObserver.\n * */\nexport class CustomResizeObserver {\n  records: Array<{\n    target: HTMLElement;\n    iframe: HTMLIFrameElement;\n  }> = [];\n  mutationObserverFallback: MutationObserver | null = null;\n\n  constructor(private readonly updateFunction: () => void) {\n    this.updateFunction = updateFunction;\n  }\n\n  observe(element: HTMLElement) {\n    if (isPositioned(element)) {\n      return this.observeUsingIframe(element);\n    }\n    return this.observeUsingMutationObserver(element);\n  }\n\n  appendToTheDOM() {\n    for (let record of this.records) {\n      record.target.appendChild(record.iframe);\n    }\n\n    for (let record of this.records) {\n      if (record.iframe.contentWindow) {\n        record.iframe.contentWindow.addEventListener('resize', this.updateFunction);\n      }\n    }\n  }\n\n  observeUsingIframe(element: HTMLElement) {\n    const iframe = element.ownerDocument.createElement('iframe');\n    iframe.src = 'javascript:void(0)';\n    iframe.ariaHidden = 'true';\n    iframe.tabIndex = -1;\n    Object.assign(iframe.style, defaultIframeStyles);\n\n    this.records.push({ target: element, iframe });\n  }\n\n  observeUsingMutationObserver(element: HTMLElement) {\n    if (!this.mutationObserverFallback) {\n      this.mutationObserverFallback = new MutationObserver(this.updateFunction);\n    }\n\n    this.mutationObserverFallback.observe(element, {\n      childList: true,\n      subtree: true,\n    });\n  }\n\n  disconnect() {\n    this.records.map(({ target, iframe }) => {\n      if (iframe.contentWindow) {\n        iframe.contentWindow.removeEventListener('resize', this.updateFunction);\n      }\n\n      target.removeChild(iframe);\n    });\n    this.records = [];\n\n    if (this.mutationObserverFallback) {\n      this.mutationObserverFallback.disconnect();\n    }\n    this.mutationObserverFallback = null;\n  }\n}\n\nfunction isPositioned(element: HTMLElement): boolean {\n  return getComputedStyle(element).position !== 'static';\n}\n"],"names":["CustomResizeObserver","defaultIframeStyles","position","left","top","zIndex","width","height","pointerEvents","opacity","observe","element","isPositioned","observeUsingIframe","observeUsingMutationObserver","appendToTheDOM","record","records","target","appendChild","iframe","contentWindow","addEventListener","updateFunction","ownerDocument","createElement","src","ariaHidden","tabIndex","Object","assign","style","push","mutationObserverFallback","MutationObserver","childList","subtree","disconnect","map","removeEventListener","removeChild","constructor","getComputedStyle"],"mappings":";;;;+BA6BaA;;;eAAAA;;;;AA7Bb,MAAMC,sBAGF;IACFC,UAAU;IACVC,MAAM;IACNC,KAAK;IACLC,QAAQ;IACRC,OAAO;IACPC,QAAQ;IACRC,eAAe;IACfC,SAAS;AACX;AAiBO,MAAMT;IAWXU,QAAQC,OAAoB,EAAE;QAC5B,IAAIC,aAAaD,UAAU;YACzB,OAAO,IAAI,CAACE,kBAAkB,CAACF;QACjC;QACA,OAAO,IAAI,CAACG,4BAA4B,CAACH;IAC3C;IAEAI,iBAAiB;QACf,KAAK,IAAIC,UAAU,IAAI,CAACC,OAAO,CAAE;YAC/BD,OAAOE,MAAM,CAACC,WAAW,CAACH,OAAOI,MAAM;QACzC;QAEA,KAAK,IAAIJ,UAAU,IAAI,CAACC,OAAO,CAAE;YAC/B,IAAID,OAAOI,MAAM,CAACC,aAAa,EAAE;gBAC/BL,OAAOI,MAAM,CAACC,aAAa,CAACC,gBAAgB,CAAC,UAAU,IAAI,CAACC,cAAc;YAC5E;QACF;IACF;IAEAV,mBAAmBF,OAAoB,EAAE;QACvC,MAAMS,SAAST,QAAQa,aAAa,CAACC,aAAa,CAAC;QACnDL,OAAOM,GAAG,GAAG;QACbN,OAAOO,UAAU,GAAG;QACpBP,OAAOQ,QAAQ,GAAG,CAAC;QACnBC,OAAOC,MAAM,CAACV,OAAOW,KAAK,EAAE9B;QAE5B,IAAI,CAACgB,OAAO,CAACe,IAAI,CAAC;YAAEd,QAAQP;YAASS;QAAO;IAC9C;IAEAN,6BAA6BH,OAAoB,EAAE;QACjD,IAAI,CAAC,IAAI,CAACsB,wBAAwB,EAAE;YAClC,IAAI,CAACA,wBAAwB,GAAG,IAAIC,iBAAiB,IAAI,CAACX,cAAc;QAC1E;QAEA,IAAI,CAACU,wBAAwB,CAACvB,OAAO,CAACC,SAAS;YAC7CwB,WAAW;YACXC,SAAS;QACX;IACF;IAEAC,aAAa;QACX,IAAI,CAACpB,OAAO,CAACqB,GAAG,CAAC,CAAC,EAAEpB,MAAM,EAAEE,MAAM,EAAE;YAClC,IAAIA,OAAOC,aAAa,EAAE;gBACxBD,OAAOC,aAAa,CAACkB,mBAAmB,CAAC,UAAU,IAAI,CAAChB,cAAc;YACxE;YAEAL,OAAOsB,WAAW,CAACpB;QACrB;QACA,IAAI,CAACH,OAAO,GAAG,EAAE;QAEjB,IAAI,IAAI,CAACgB,wBAAwB,EAAE;YACjC,IAAI,CAACA,wBAAwB,CAACI,UAAU;QAC1C;QACA,IAAI,CAACJ,wBAAwB,GAAG;IAClC;IA1DAQ,YAAY,AAAiBlB,cAA0B,CAAE;;QANzDN,yBAAAA,WAAAA,KAAAA;QAIAgB,yBAAAA,4BAAAA,KAAAA;aAE6BV,iBAAAA;aAN7BN,UAGK,EAAE;aACPgB,2BAAoD;QAGlD,IAAI,CAACV,cAAc,GAAGA;IACxB;AAyDF;AAEA,SAASX,aAAaD,OAAoB;IACxC,OAAO+B,iBAAiB/B,SAAST,QAAQ,KAAK;AAChD"}