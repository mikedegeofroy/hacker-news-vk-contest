{"version":3,"sources":["../../../../src/lib/floating/customResizeObserver.ts"],"sourcesContent":["const defaultIframeStyles: Pick<\n  CSSStyleDeclaration,\n  'position' | 'left' | 'top' | 'zIndex' | 'width' | 'height' | 'pointerEvents' | 'opacity'\n> = {\n  position: 'absolute',\n  left: '0',\n  top: '0',\n  zIndex: '-1',\n  width: '100%',\n  height: '100%',\n  pointerEvents: 'none',\n  opacity: '0',\n};\n\n/*\n * Специальный CustomResizeObserver как fallback для ResizeObserver\n * Используется для вызова update() функции (перерисовка плавающего окна) floating-ui\n * при изменении размера reference или floating элементов.\n *\n * По умолчанию пытаемся нарисовать скрытый, абсолютно позиционированный относительно\n * наблюдаемого элемента iframe.\n * В случае же, если наблюдаемый элемент имеет position: static, то правильно спозиционировать\n * iframe у нас не получится, поэтому в такой ситуации мы используем MutationObserver.\n *\n * Использовать только MutationObserver мы не можем, потому что с помощью него нельзя отследить\n * изменение размера вызванное переполнением текста.\n *\n * Применяется только если нету поддержики или полифила ResizeObserver.\n * */\nexport class CustomResizeObserver {\n  records: Array<{\n    target: HTMLElement;\n    iframe: HTMLIFrameElement;\n  }> = [];\n  mutationObserverFallback: MutationObserver | null = null;\n\n  constructor(private readonly updateFunction: () => void) {\n    this.updateFunction = updateFunction;\n  }\n\n  observe(element: HTMLElement) {\n    if (isPositioned(element)) {\n      return this.observeUsingIframe(element);\n    }\n    return this.observeUsingMutationObserver(element);\n  }\n\n  appendToTheDOM() {\n    for (let record of this.records) {\n      record.target.appendChild(record.iframe);\n    }\n\n    for (let record of this.records) {\n      if (record.iframe.contentWindow) {\n        record.iframe.contentWindow.addEventListener('resize', this.updateFunction);\n      }\n    }\n  }\n\n  observeUsingIframe(element: HTMLElement) {\n    const iframe = element.ownerDocument.createElement('iframe');\n    iframe.src = 'javascript:void(0)';\n    iframe.ariaHidden = 'true';\n    iframe.tabIndex = -1;\n    Object.assign(iframe.style, defaultIframeStyles);\n\n    this.records.push({ target: element, iframe });\n  }\n\n  observeUsingMutationObserver(element: HTMLElement) {\n    if (!this.mutationObserverFallback) {\n      this.mutationObserverFallback = new MutationObserver(this.updateFunction);\n    }\n\n    this.mutationObserverFallback.observe(element, {\n      childList: true,\n      subtree: true,\n    });\n  }\n\n  disconnect() {\n    this.records.map(({ target, iframe }) => {\n      if (iframe.contentWindow) {\n        iframe.contentWindow.removeEventListener('resize', this.updateFunction);\n      }\n\n      target.removeChild(iframe);\n    });\n    this.records = [];\n\n    if (this.mutationObserverFallback) {\n      this.mutationObserverFallback.disconnect();\n    }\n    this.mutationObserverFallback = null;\n  }\n}\n\nfunction isPositioned(element: HTMLElement): boolean {\n  return getComputedStyle(element).position !== 'static';\n}\n"],"names":["defaultIframeStyles","position","left","top","zIndex","width","height","pointerEvents","opacity","CustomResizeObserver","records","mutationObserverFallback","constructor","updateFunction","observe","element","isPositioned","observeUsingIframe","observeUsingMutationObserver","appendToTheDOM","record","target","appendChild","iframe","contentWindow","addEventListener","ownerDocument","createElement","src","ariaHidden","tabIndex","Object","assign","style","push","MutationObserver","childList","subtree","disconnect","map","removeEventListener","removeChild","getComputedStyle"],"mappings":"AAAA,MAAMA,sBAGF;IACFC,UAAU;IACVC,MAAM;IACNC,KAAK;IACLC,QAAQ;IACRC,OAAO;IACPC,QAAQ;IACRC,eAAe;IACfC,SAAS;AACX;AAEA;;;;;;;;;;;;;;GAcG,GACH,OAAO,MAAMC;;IACXC,QAGQ;IACRC,yBAAyD;IAEzDC,YAAY,AAAiBC,cAA0B,CAAE;aAA5BA,iBAAAA;aAN7BH,UAGK,EAAE;aACPC,2BAAoD;QAGlD,IAAI,CAACE,cAAc,GAAGA;IACxB;IAEAC,QAAQC,OAAoB,EAAE;QAC5B,IAAIC,aAAaD,UAAU;YACzB,OAAO,IAAI,CAACE,kBAAkB,CAACF;QACjC;QACA,OAAO,IAAI,CAACG,4BAA4B,CAACH;IAC3C;IAEAI,iBAAiB;QACf,KAAK,IAAIC,UAAU,IAAI,CAACV,OAAO,CAAE;YAC/BU,OAAOC,MAAM,CAACC,WAAW,CAACF,OAAOG,MAAM;QACzC;QAEA,KAAK,IAAIH,UAAU,IAAI,CAACV,OAAO,CAAE;YAC/B,IAAIU,OAAOG,MAAM,CAACC,aAAa,EAAE;gBAC/BJ,OAAOG,MAAM,CAACC,aAAa,CAACC,gBAAgB,CAAC,UAAU,IAAI,CAACZ,cAAc;YAC5E;QACF;IACF;IAEAI,mBAAmBF,OAAoB,EAAE;QACvC,MAAMQ,SAASR,QAAQW,aAAa,CAACC,aAAa,CAAC;QACnDJ,OAAOK,GAAG,GAAG;QACbL,OAAOM,UAAU,GAAG;QACpBN,OAAOO,QAAQ,GAAG,CAAC;QACnBC,OAAOC,MAAM,CAACT,OAAOU,KAAK,EAAEjC;QAE5B,IAAI,CAACU,OAAO,CAACwB,IAAI,CAAC;YAAEb,QAAQN;YAASQ;QAAO;IAC9C;IAEAL,6BAA6BH,OAAoB,EAAE;QACjD,IAAI,CAAC,IAAI,CAACJ,wBAAwB,EAAE;YAClC,IAAI,CAACA,wBAAwB,GAAG,IAAIwB,iBAAiB,IAAI,CAACtB,cAAc;QAC1E;QAEA,IAAI,CAACF,wBAAwB,CAACG,OAAO,CAACC,SAAS;YAC7CqB,WAAW;YACXC,SAAS;QACX;IACF;IAEAC,aAAa;QACX,IAAI,CAAC5B,OAAO,CAAC6B,GAAG,CAAC,CAAC,EAAElB,MAAM,EAAEE,MAAM,EAAE;YAClC,IAAIA,OAAOC,aAAa,EAAE;gBACxBD,OAAOC,aAAa,CAACgB,mBAAmB,CAAC,UAAU,IAAI,CAAC3B,cAAc;YACxE;YAEAQ,OAAOoB,WAAW,CAAClB;QACrB;QACA,IAAI,CAACb,OAAO,GAAG,EAAE;QAEjB,IAAI,IAAI,CAACC,wBAAwB,EAAE;YACjC,IAAI,CAACA,wBAAwB,CAAC2B,UAAU;QAC1C;QACA,IAAI,CAAC3B,wBAAwB,GAAG;IAClC;AACF;AAEA,SAASK,aAAaD,OAAoB;IACxC,OAAO2B,iBAAiB3B,SAASd,QAAQ,KAAK;AAChD"}