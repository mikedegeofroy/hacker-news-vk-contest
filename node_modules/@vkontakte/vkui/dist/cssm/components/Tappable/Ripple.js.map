{"version":3,"sources":["../../../../src/components/Tappable/Ripple.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames, hasMouse as hasPointerLib, noop } from '@vkontakte/vkjs';\nimport { usePlatform } from '../../hooks/usePlatform';\nimport { useTimeout } from '../../hooks/useTimeout';\nimport { getOffsetRect } from '../../lib/offset';\nimport styles from './Tappable.module.css';\n\n/**\n * Возможно нужен Ripple эффект. Данный хук нужен для отказа\n * от двойного ререндера.\n */\nexport const useMaybeNeedRipple = (activeMode: string, hasPointer: boolean | undefined) => {\n  const platform = usePlatform();\n\n  return platform === 'android' && !hasPointer && activeMode === 'background';\n};\n\ninterface Wave {\n  x: number;\n  y: number;\n  id: number;\n  pointerId: number;\n}\n\nconst DELAY = 70;\nconst WAVE_LIVE = 225;\n\n/**\n * Хук для создания Ripple эффектов\n */\nexport const useRipple = (needRipple: boolean, hasPointerContext: boolean | undefined) => {\n  const [clicks, setClicks] = React.useState<Wave[]>([]);\n\n  /**\n   * Коллекция нажатий и таймеров задержки появления волны\n   */\n  const pointerDelayTimers = React.useMemo(\n    () => new Map<number, ReturnType<typeof setTimeout>>(),\n    [],\n  );\n\n  const clearClicks = useTimeout(() => setClicks([]), WAVE_LIVE);\n\n  function addClick(x: number, y: number, pointerId: number) {\n    const dateNow = Date.now();\n    const filteredClicks = clicks.filter((click) => click.id + WAVE_LIVE > dateNow);\n\n    setClicks([...filteredClicks, { x, y, id: dateNow, pointerId }]);\n    clearClicks.set();\n    pointerDelayTimers.delete(pointerId);\n  }\n\n  /**\n   * Добавляем волну с задержкой. Задержка необходима при отмене волны.\n   */\n  const onPointerDown: React.PointerEventHandler<HTMLSpanElement> = (e) => {\n    const { top, left } = getOffsetRect(e.currentTarget);\n    const x = e.clientX - (left ?? 0);\n    const y = e.clientY - (top ?? 0);\n\n    pointerDelayTimers.set(\n      e.pointerId,\n      setTimeout(() => addClick(x, y, e.pointerId), DELAY),\n    );\n  };\n\n  const onPointerCancel: React.PointerEventHandler<HTMLSpanElement> = (e) => {\n    const timer = pointerDelayTimers.get(e.pointerId);\n    clearTimeout(timer);\n    pointerDelayTimers.delete(e.pointerId);\n  };\n\n  // WARNING: не использовать для рендеринга\n  const reallyNeedRipple = (!hasPointerLib || hasPointerContext === false) && needRipple;\n\n  return {\n    clicks,\n    onPointerDown: reallyNeedRipple ? onPointerDown : noop,\n    onPointerCancel: reallyNeedRipple ? onPointerCancel : noop,\n  };\n};\n\nexport interface RippleProps {\n  needRipple: boolean;\n  clicks: Wave[];\n}\n\nexport const Ripple = ({ needRipple = true, clicks }: RippleProps) => {\n  return (\n    <span\n      aria-hidden\n      className={classNames(\n        styles['Tappable__stateLayer'],\n        needRipple && styles['Tappable__ripple'],\n      )}\n    >\n      {clicks.map((wave) => (\n        <span\n          key={wave.id}\n          className={styles['Tappable__wave']}\n          style={{ top: wave.y, left: wave.x }}\n        />\n      ))}\n    </span>\n  );\n};\n"],"names":["React","classNames","hasMouse","hasPointerLib","noop","usePlatform","useTimeout","getOffsetRect","styles","useMaybeNeedRipple","activeMode","hasPointer","platform","DELAY","WAVE_LIVE","useRipple","needRipple","hasPointerContext","clicks","setClicks","useState","pointerDelayTimers","useMemo","Map","clearClicks","addClick","x","y","pointerId","dateNow","Date","now","filteredClicks","filter","click","id","set","delete","onPointerDown","e","top","left","currentTarget","clientX","clientY","setTimeout","onPointerCancel","timer","get","clearTimeout","reallyNeedRipple","Ripple","span","aria-hidden","className","map","wave","key","style"],"mappings":"AAAA,YAAYA,WAAW,QAAQ;AAC/B,SAASC,UAAU,EAAEC,YAAYC,aAAa,EAAEC,IAAI,QAAQ,kBAAkB;AAC9E,SAASC,WAAW,QAAQ,0BAA0B;AACtD,SAASC,UAAU,QAAQ,yBAAyB;AACpD,SAASC,aAAa,QAAQ,mBAAmB;AACjD,OAAOC,YAAY,wBAAwB;AAE3C;;;CAGC,GACD,OAAO,MAAMC,qBAAqB,CAACC,YAAoBC;IACrD,MAAMC,WAAWP;IAEjB,OAAOO,aAAa,aAAa,CAACD,cAAcD,eAAe;AACjE,EAAE;AASF,MAAMG,QAAQ;AACd,MAAMC,YAAY;AAElB;;CAEC,GACD,OAAO,MAAMC,YAAY,CAACC,YAAqBC;IAC7C,MAAM,CAACC,QAAQC,UAAU,GAAGnB,MAAMoB,QAAQ,CAAS,EAAE;IAErD;;GAEC,GACD,MAAMC,qBAAqBrB,MAAMsB,OAAO,CACtC,IAAM,IAAIC,OACV,EAAE;IAGJ,MAAMC,cAAclB,WAAW,IAAMa,UAAU,EAAE,GAAGL;IAEpD,SAASW,SAASC,CAAS,EAAEC,CAAS,EAAEC,SAAiB;QACvD,MAAMC,UAAUC,KAAKC,GAAG;QACxB,MAAMC,iBAAiBd,OAAOe,MAAM,CAAC,CAACC,QAAUA,MAAMC,EAAE,GAAGrB,YAAYe;QAEvEV,UAAU;eAAIa;YAAgB;gBAAEN;gBAAGC;gBAAGQ,IAAIN;gBAASD;YAAU;SAAE;QAC/DJ,YAAYY,GAAG;QACff,mBAAmBgB,MAAM,CAACT;IAC5B;IAEA;;GAEC,GACD,MAAMU,gBAA4D,CAACC;QACjE,MAAM,EAAEC,GAAG,EAAEC,IAAI,EAAE,GAAGlC,cAAcgC,EAAEG,aAAa;QACnD,MAAMhB,IAAIa,EAAEI,OAAO,GAAIF,CAAAA,QAAQ,CAAA;QAC/B,MAAMd,IAAIY,EAAEK,OAAO,GAAIJ,CAAAA,OAAO,CAAA;QAE9BnB,mBAAmBe,GAAG,CACpBG,EAAEX,SAAS,EACXiB,WAAW,IAAMpB,SAASC,GAAGC,GAAGY,EAAEX,SAAS,GAAGf;IAElD;IAEA,MAAMiC,kBAA8D,CAACP;QACnE,MAAMQ,QAAQ1B,mBAAmB2B,GAAG,CAACT,EAAEX,SAAS;QAChDqB,aAAaF;QACb1B,mBAAmBgB,MAAM,CAACE,EAAEX,SAAS;IACvC;IAEA,0CAA0C;IAC1C,MAAMsB,mBAAmB,AAAC,CAAA,CAAC/C,iBAAiBc,sBAAsB,KAAI,KAAMD;IAE5E,OAAO;QACLE;QACAoB,eAAeY,mBAAmBZ,gBAAgBlC;QAClD0C,iBAAiBI,mBAAmBJ,kBAAkB1C;IACxD;AACF,EAAE;AAOF,OAAO,MAAM+C,SAAS,CAAC,EAAEnC,aAAa,IAAI,EAAEE,MAAM,EAAe;IAC/D,qBACE,oBAACkC;QACCC,eAAAA;QACAC,WAAWrD,WACTO,MAAM,CAAC,uBAAuB,EAC9BQ,cAAcR,MAAM,CAAC,mBAAmB;OAGzCU,OAAOqC,GAAG,CAAC,CAACC,qBACX,oBAACJ;YACCK,KAAKD,KAAKrB,EAAE;YACZmB,WAAW9C,MAAM,CAAC,iBAAiB;YACnCkD,OAAO;gBAAElB,KAAKgB,KAAK7B,CAAC;gBAAEc,MAAMe,KAAK9B,CAAC;YAAC;;AAK7C,EAAE"}